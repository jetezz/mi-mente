

services:
  # -------------------------------------------------------
  # 1. WORKER PYTHON (IA & Descargas)
  # -------------------------------------------------------
  worker-py:
    build: ./apps/worker-py
    container_name: brain-worker
    restart: always
    # ports:
    #   - "8000:8000" # Acceso externo opcional para pruebas
    volumes:
      # Persistencia de modelos Whisper para no descargarlos en cada reinicio
      - ./apps/worker-py/models:/root/.cache/huggingface
      # Persistencia para cookies de instagram si fuera necesario
      - ./apps/worker-py/cookies:/app/cookies
    env_file: .env
    networks:
      - brain-network

  # -------------------------------------------------------
  # 2. API ORCHESTRATOR (Bun + Elysia)
  # -------------------------------------------------------
  api-bun:
    build: ./apps/api-bun
    container_name: brain-api
    restart: always
    # ports:
    #   - "3000:3000"
    environment:
      # Aqu√≠ definimos la URL interna del worker con el nombre del servicio docker
      - WORKER_URL=http://worker-py:8000
    env_file: .env
    # volumes:
    #   - ./apps/api-bun:/app
    #   - /app/node_modules
    # command: bun run dev
    depends_on:
      - worker-py
    networks:
      - brain-network

  # -------------------------------------------------------
  # 3. FRONTEND (Astro)
  # -------------------------------------------------------
  web:
    build: ./apps/web
    container_name: brain-web
    restart: always
    ports:
      - "4321:4321"
    environment:
      - PUBLIC_API_URL=${PUBLIC_API_URL} 
    # volumes:
    #   - ./apps/web:/app
    #   - /app/node_modules
    # command: bun run dev --host
    networks:
      - brain-network

# Red interna privada
networks:
  brain-network:
    driver: bridge
